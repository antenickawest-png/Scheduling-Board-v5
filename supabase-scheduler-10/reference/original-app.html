<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>R&S Weekly Schedule</title>
<style>
/* Base Styles with Purple Pastel Color Scheme */
:root {
  --primary-color: #d1a3ff; /* Main purple pastel */
  --secondary-color: #f0d4ff; /* Lighter purple pastel */
  --accent-color: #b5c9ff; /* Complementary blue pastel */
  --light-color: #f8f5ff; /* Very light purple tint */
  --dark-color: #4a3b5c; /* Dark purple for text */
  --success-color: #c8e6c9; /* Light green */
  --warning-color: #fff0c8; /* Light yellow */
  --danger-color: #ffcdd2; /* Light red */
  --border-radius: 8px;
  --box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

body { 
  font-family: 'Segoe UI', sans-serif; 
  background: var(--light-color); 
  margin: 0; 
  padding: 0;
  color: var(--dark-color);
}

/* Login Page Styles */
.login-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
}

.login-box {
  background: white;
  padding: 30px;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  width: 350px;
  max-width: 90%;
  text-align: center;
}

.login-box h2 {
  margin-bottom: 20px;
  color: var(--dark-color);
}

.login-form input {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border: 1px solid #ddd;
  border-radius: var(--border-radius);
  box-sizing: border-box;
}

.login-form button {
  width: 100%;
  padding: 10px;
  background: var(--primary-color);
  color: var(--dark-color);
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  font-size: 16px;
  margin-top: 10px;
}

.login-form button:hover {
  background: #c08aff;
}

.forgot-password {
  margin-top: 15px;
  font-size: 14px;
  color: #666;
  cursor: pointer;
}

.forgot-password:hover {
  text-decoration: underline;
}

.login-error {
  color: #e74c3c;
  margin-bottom: 15px;
  font-size: 14px;
  display: none;
}

/* Main App Styles */
header { 
  background: var(--primary-color); 
  padding: 10px; 
  display: flex; 
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.header-title {
  font-size: 1.2rem;
  font-weight: bold;
  color: var(--dark-color);
  margin: 5px 0;
}

nav {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  justify-content: center;
}

nav button { 
  background: transparent; 
  border: none; 
  color: var(--dark-color); 
  font-size: 16px; 
  margin: 5px; 
  cursor: pointer; 
  padding: 5px 10px;
  border-radius: var(--border-radius);
}

nav button:hover {
  background: rgba(255, 255, 255, 0.3);
}

nav button.active { 
  background: white; 
  color: var(--dark-color); 
  font-weight: bold; 
  border-radius: var(--border-radius); 
}

.user-controls {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  justify-content: center;
  margin: 5px 0;
}

.user-info {
  margin-right: 15px;
  font-size: 14px;
}

.logout-btn {
  background: var(--secondary-color);
  color: var(--dark-color);
  border: none;
  padding: 5px 10px;
  border-radius: var(--border-radius);
  cursor: pointer;
}

.page { 
  display: none; 
  padding: 20px; 
}

.page.active { 
  display: block; 
}

.controls { 
  text-align: center; 
  margin-bottom: 20px; 
  background: var(--secondary-color);
  padding: 15px;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  overflow-x: auto;
}

button.primary { 
  padding: 8px 12px; 
  margin: 5px; 
  background: var(--primary-color); 
  color: var(--dark-color); 
  border: none; 
  border-radius: var(--border-radius); 
  cursor: pointer; 
  font-size: 14px; 
  transition: all 0.2s;
  white-space: nowrap;
}

button.primary:hover {
  background: #c08aff;
  transform: translateY(-2px);
}

h1, h2 {
  color: var(--dark-color);
  margin-bottom: 20px;
  text-align: center;
}

/* Resources Styles */
.resources { 
  display: flex; 
  gap: 20px; 
  margin-bottom: 20px; 
  flex-wrap: wrap;
  justify-content: center;
}

.resource-section { 
  background: white; 
  border: 1px solid var(--secondary-color); 
  border-radius: var(--border-radius); 
  padding: 15px; 
  width: 180px;
  box-shadow: var(--box-shadow);
  min-width: 150px;
  flex: 1;
  max-width: 250px;
}

.resource-section h3 { 
  margin: 0 0 10px 0; 
  font-size: 16px; 
  text-align: center; 
  color: var(--dark-color);
  padding-bottom: 5px;
  border-bottom: 2px solid var(--primary-color);
}

.resource-section textarea { 
  width: 100%; 
  height: 60px; 
  padding: 8px; 
  margin-bottom: 10px; 
  border: 1px solid var(--primary-color); 
  border-radius: var(--border-radius); 
  font-size: 14px;
  box-sizing: border-box;
  resize: vertical;
}

.resource-section input[type="text"] { 
  display: none; 
}

.resource-list { 
  max-height: 150px; 
  overflow-y: auto; 
  border: 1px dashed var(--secondary-color); 
  padding: 8px;
  border-radius: var(--border-radius);
  background: #fafafa;
}

/* Board Styles */
.board { 
  display: flex; 
  overflow-x: auto; 
  gap: 15px; 
  padding: 15px; 
  min-height: 250px; 
  border-top: 1px solid var(--secondary-color);
  background: var(--light-color);
  border-radius: var(--border-radius);
  margin-bottom: 20px;
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
}

.column { 
  background: white; 
  border: 2px solid var(--secondary-color); 
  border-radius: var(--border-radius); 
  width: 180px; 
  min-height: 220px; 
  padding: 10px; 
  display: flex; 
  flex-direction: column;
  box-shadow: var(--box-shadow);
  flex: 0 0 auto;
  cursor: pointer; /* Make site columns clickable for selection */
}

.column input { 
  border: 1px solid var(--primary-color); 
  border-radius: var(--border-radius); 
  padding: 8px; 
  margin-bottom: 10px; 
  font-size: 14px;
  text-align: center;
  font-weight: bold;
}

/* Removed column selection styling */
/* .column.selected { 
  border: 2px solid #ff9e80; 
  background-color: #fff8e0; 
} */

/* Status Boxes Styles */
.permanent-boxes-header { 
  margin-top: 30px; 
  border-top: 1px solid var(--secondary-color); 
  padding-top: 20px; 
}

.permanent-boxes-container { 
  display: flex; 
  justify-content: space-around; 
  margin: 20px 0;
  flex-wrap: wrap;
  gap: 15px;
}

.permanent-box { 
  background: white; 
  border: 2px solid var(--secondary-color); 
  border-radius: var(--border-radius); 
  width: 22%; 
  min-height: 150px; 
  padding: 10px;
  box-shadow: var(--box-shadow);
  min-width: 200px;
  flex: 1;
}

.permanent-box h3 { 
  text-align: center; 
  margin: 5px 0 10px 0; 
  background: var(--secondary-color); 
  padding: 8px; 
  border-radius: var(--border-radius);
  color: var(--dark-color);
}

/* Tile Styles */
.tile { 
  padding: 8px; 
  border-radius: var(--border-radius); 
  margin: 5px 0; 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  cursor: move; 
  font-size: 14px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  touch-action: none; /* Improves touch handling */
}

.tile.crew { 
  background: var(--primary-color); 
}

.tile.truck { 
  background: var(--secondary-color); 
}

.tile.trailer { 
  background: var(--success-color); 
}

.tile.equipment { 
  background: var(--warning-color); 
}

.tile.combo { 
  background: linear-gradient(135deg, var(--primary-color) 25%, var(--secondary-color) 25%, var(--secondary-color) 50%, var(--success-color) 50%, var(--success-color) 75%, var(--warning-color) 75%); 
}

.tile-buttons button { 
  background: transparent; 
  border: none; 
  font-size: 14px; 
  cursor: pointer; 
  margin-left: 5px;
  opacity: 0.7;
  transition: opacity 0.2s;
  min-width: 24px;
  min-height: 24px;
}

.tile-buttons button:hover {
  opacity: 1;
}

.tile.selected { 
  border: 2px solid #ff9e80; 
  box-shadow: 0 0 5px rgba(255, 158, 128, 0.5);
}

/* Location Styles */
.location-zone { 
  background: white; 
  border: 2px solid var(--secondary-color); 
  border-radius: var(--border-radius); 
  width: 220px; 
  min-height: 200px; 
  padding: 10px; 
  margin: 10px;
  box-shadow: var(--box-shadow);
  flex: 1;
  min-width: 200px;
}

.location-zone h3 { 
  text-align: center; 
  margin: 5px 0 10px 0;
  background: var(--secondary-color);
  padding: 8px;
  border-radius: var(--border-radius);
  color: var(--dark-color);
}

.location-container { 
  display: flex; 
  flex-wrap: wrap; 
  justify-content: center; 
  margin-top: 20px; 
  gap: 15px;
}

.locations-header { 
  margin-top: 30px; 
  border-top: 1px solid var(--secondary-color); 
  padding-top: 20px; 
}

/* Combo Controls */
.combo-controls { 
  margin: 15px 0; 
  text-align: center;
  background: var(--secondary-color);
  padding: 15px;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}

.combo-name { 
  width: 180px; 
  padding: 8px; 
  margin-right: 10px;
  border: 1px solid var(--primary-color);
  border-radius: var(--border-radius);
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.fade-in {
  animation: fadeIn 0.3s ease-in;
}

/* Tooltips */
.tooltip {
  position: relative;
  display: inline-block;
}

.tooltip .tooltip-text {
  visibility: hidden;
  width: 120px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -60px;
  opacity: 0;
  transition: opacity 0.3s;
}

.tooltip:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}

/* Enhanced Mobile Responsiveness */
@media (max-width: 768px) {
  header {
    flex-direction: column;
    padding: 10px 5px;
  }
  
  .header-title {
    margin-bottom: 10px;
  }
  
  nav {
    width: 100%;
    justify-content: center;
    margin-bottom: 10px;
  }
  
  nav button {
    padding: 8px;
    margin: 3px;
    font-size: 14px;
  }
  
  .user-controls {
    width: 100%;
    justify-content: center;
  }
  
  .resources {
    flex-direction: column;
    align-items: center;
  }
  
  .resource-section {
    width: 90%;
    max-width: none;
  }
  
  .permanent-box {
    width: 90%;
    margin-bottom: 15px;
    min-width: 0;
  }
  
  .location-zone {
    width: 90%;
    min-width: 0;
  }
  
  .controls {
    padding: 10px;
  }
  
  button.primary {
    padding: 10px 15px;
    font-size: 13px;
  }
  
  .combo-name {
    width: 100%;
    margin-right: 0;
    margin-bottom: 10px;
  }
  
  .combo-controls {
    padding: 10px;
  }
  
  .board {
    padding: 10px 5px;
  }
  
  .column {
    min-width: 160px;
  }
}

/* Touch-friendly improvements */
@media (pointer: coarse) {
  .tile {
    padding: 12px 8px;
    margin: 8px 0;
  }
  
  .tile-buttons button {
    padding: 5px;
    min-width: 30px;
    min-height: 30px;
  }
  
  button.primary {
    padding: 10px 15px;
  }
  
  .column input {
    padding: 10px;
  }
  
  select, input[type="text"], input[type="password"] {
    font-size: 16px; /* Prevents iOS zoom on focus */
    padding: 10px;
  }
}
</style>
</head>
<body>
<!-- Login Page -->
<div id="loginPage" class="login-container">
  <div class="login-box">
    <h2>🔐 R&S Weekly Schedule</h2>
    <div id="loginError" class="login-error">Invalid password</div>
    <form class="login-form" id="loginForm" onsubmit="return false;">
      <input type="password" id="password" placeholder="Enter Password (____)" required>
      <button type="submit" onclick="attemptLogin()">🚀 Login</button>
    </form>
  </div>
</div>

<!-- Main Application -->
<div id="appContainer" style="display: none;">
  <header>
    <div class="header-title">R&S Weekly Schedule</div>
    <nav>
      <button id="tab1" class="active" onclick="showPage(1)">📋 Board & Resources</button>
      <button id="tab2" onclick="showPage(2)">💾 Saved Schedules</button>
    </nav>
    <div class="user-controls">
      <button class="logout-btn" onclick="logout()">🚪 Logout</button>
    </div>
  </header>

  <!-- Page 1: Board & Resources -->
  <div id="page1" class="page active">
    <h1>📅 Weekly Sites & Resources</h1>
    <div class="controls">
      <button class="primary pdf-btn" onclick="exportToPDF()">📄 Export PDF</button>
      <button class="primary" onclick="addSite()">➕ Add Site</button>
      <button class="primary" onclick="deleteSite()">🗑️ Delete Site</button>
      <button class="primary" onclick="clearSites()">🧹 Clear Board</button>
      <button class="primary" onclick="eraseBoard()">🗑️ Erase Board</button>
      <button class="primary" onclick="saveSnapshot()">📸 Save Snapshot</button>
      <button class="primary" onclick="syncData()" id="syncBtn">🔄 Sync Data</button>
    </div>
    
    <div class="resources">
      <div class="resource-section">
        <h3>👷 Crew</h3>
        <textarea id="crewInput" placeholder="One name per line"></textarea>
        <button class="primary" onclick="addCrew()">➕ </button>
        <button class="primary" onclick="clearCrew()">🧹 </button>
        <div id="crewList" class="resource-list" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
      </div>
      <div class="resource-section">
        <h3>🚚 Trucks</h3>
        <textarea id="truckInput" placeholder="One tag per line"></textarea>
        <button class="primary" onclick="addTruck()">➕ </button>
        <button class="primary" onclick="clearTruck()">🧹 </button>
        <div id="truckList" class="resource-list" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
      </div>
      <div class="resource-section">
        <h3>🚛 Trailers</h3>
        <textarea id="trailerInput" placeholder="One tag per line"></textarea>
        <button class="primary" onclick="addTrailer()">➕ </button>
        <button class="primary" onclick="clearTrailer()">🧹 </button>
        <div id="trailerList" class="resource-list" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
      </div>
      <div class="resource-section">
        <h3>🔧 Equipment</h3>
        <textarea id="equipmentInput" placeholder="One item per line"></textarea>
        <button class="primary" onclick="addEquipment()">➕ </button>
        <button class="primary" onclick="clearEquipment()">🧹 </button>
        <div id="equipmentList" class="resource-list" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
      </div>
    </div>
    
    <div class="board" id="board" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
    
    <!-- Permanent Status Boxes -->
    <div class="permanent-boxes-header">
      <h2>📊 Status Zones</h2>
    </div>
    <div class="permanent-boxes-container">
      <div class="permanent-box" id="off-box" ondragover="allowDrop(event)" ondrop="drop(event)">
        <h3>🏠 Off</h3>
      </div>
      <div class="permanent-box" id="available-box" ondragover="allowDrop(event)" ondrop="drop(event)">
        <h3>✅ Available</h3>
      </div>
      <div class="permanent-box" id="shop-box" ondragover="allowDrop(event)" ondrop="drop(event)">
        <h3>🔧 Shop/Logistics</h3>
      </div>
      <div class="permanent-box" id="djmuse-box" ondragover="allowDrop(event)" ondrop="drop(event)">
        <h3>🏢 DJM Use</h3>
      </div>
    </div>

    <!-- Locations Section -->
    <div class="locations-header">
      <h2>📍 Locations</h2>
      <div class="controls">
        <button class="primary pdf-btn" onclick="exportToPDF()">📄 Export PDF</button>
        <button class="primary" onclick="saveLocationBoard()">💾 Save Locations</button>
        <button class="primary" onclick="clearLocationBoard()">🧹 Clear Locations</button>
      </div>
    </div>
    <div class="location-container">
      <div class="location-zone" id="kc-zone" ondragover="allowDrop(event)" ondrop="dropLocation(event, 'KC')">
        <h3>🏙️ KC</h3>
      </div>
      <div class="location-zone" id="indy-zone" ondragover="allowDrop(event)" ondrop="dropLocation(event, 'Indy')">
        <h3>🏁 Indy</h3>
      </div>
      <div class="location-zone" id="stl-zone" ondragover="allowDrop(event)" ondrop="dropLocation(event, 'STL')">
        <h3>🌉 STL</h3>
      </div>
    </div>
  </div>

  <!-- Page 2: Saved Schedules -->
  <div id="page2" class="page">
    <h1>💾 Saved Schedules</h1>
    <div class="controls">
      <button class="primary pdf-btn" onclick="exportToPDF()">📄 Export PDF</button>
      <select id="savedSelect"></select>
      <button class="primary" onclick="loadSavedPage2()">📂 Load Sites</button>
      <button class="primary" onclick="saveSnapshotPage2()">📸 Save Snapshot</button>
      <button class="primary" onclick="clearSavedLogs()">🧹 Clear Saved Logs</button>
    </div>
    <div id="savedBoardDisplay" class="board"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;
const SUPABASE_URL = "https://ldbjgdfkjnpxwvrofmkx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkYmpnZGZram5weHd2cm9mbWt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4OTMwMTYsImV4cCI6MjA3MDQ2OTAxNn0.2DeJq25bo_3nKG_PhkWaUUssVjUqQSRqsoeo8zZ4dFg";
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

const CORRECT_PASSWORD = '4630';
let isLoggedIn = false;

function attemptLogin() {
  const password = document.getElementById('password').value;
  
  if (password === CORRECT_PASSWORD) {
    isLoggedIn = true;
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    
    // Load data from Supabase
    loadAllData();
  } else {
    document.getElementById('loginError').style.display = 'block';
    setTimeout(() => {
      document.getElementById('loginError').style.display = 'none';
    }, 3000);
  }
}

function logout() {
  isLoggedIn = false;
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('appContainer').style.display = 'none';
  document.getElementById('password').value = '';
}

async function saveToDatabase(table, data) {
  try {
    const { error } = await supabaseClient
      .from(table)
      .upsert(data, { onConflict: 'id' });
    
    if (error) throw error;
    console.log(`[v0] Saved to ${table}:`, data);
  } catch (error) {
    console.error(`[v0] Error saving to ${table}:`, error);
  }
}

async function loadFromDatabase(table) {
  try {
    const { data, error } = await supabaseClient
      .from(table)
      .select('*');
    
    if (error) throw error;
    console.log(`[v0] Loaded from ${table}:`, data);
    return data || [];
  } catch (error) {
    console.error(`[v0] Error loading from ${table}:`, error);
    return [];
  }
}

async function deleteFromDatabase(table, id) {
  try {
    const { error } = await supabaseClient
      .from(table)
      .delete()
      .eq('id', id);
    
    if (error) throw error;
    console.log(`[v0] Deleted from ${table}:`, id);
  } catch (error) {
    console.error(`[v0] Error deleting from ${table}:`, error);
  }
}

function checkForDuplicates(name, existingItems) {
  if (!existingItems || !Array.isArray(existingItems)) {
    console.log('[v0] No existing items to check against');
    return false;
  }
  
  const duplicate = existingItems.some(item => 
    item.name && item.name.toLowerCase() === name.toLowerCase()
  );
  
  if (duplicate) {
    console.log(`[v0] Duplicate found: ${name}`);
  }
  
  return duplicate;
}

async function checkTableExists(table) {
  try {
    const { data, error } = await supabaseClient
      .from(table)
      .select('count', { count: 'exact', head: true });
    
    return !error;
  } catch (error) {
    return false;
  }
}

async function addResource(table, inputId, listId, type) {
  const input = document.getElementById(inputId);
  if (!input) return;
  
  const names = input.value.split('\n').filter(name => name.trim());
  if (names.length === 0) {
    alert('Please enter at least one name');
    return;
  }
  
  try {
    const tableExists = await checkTableExists(table);
    if (!tableExists) {
      alert(`Database table "${table}" doesn't exist. Please run the SQL script to create tables first.`);
      return;
    }
    
    const existingItems = await loadFromDatabase(table);
    
    for (const name of names) {
      const trimmedName = name.trim();
      if (!trimmedName) continue;
      
      // Check duplicates
      const isDuplicate = existingItems.some(item => 
        item.name.toLowerCase() === trimmedName.toLowerCase()
      );
      
      if (isDuplicate) {
        alert(`"${trimmedName}" already exists!`);
        continue;
      }
      
      // Create and save new item
      const newItem = {
        id: type + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        name: trimmedName
      };
      
      const { error } = await supabaseClient
        .from(table)
        .insert([newItem]);
      
      if (error) {
        console.error(`Error saving ${trimmedName}:`, error);
        alert(`Error saving ${trimmedName}: ${error.message}`);
        return;
      }
    }
    
    input.value = '';
    render(table, listId, type);
    
  } catch (error) {
    console.error('Error in addResource:', error);
    alert(`Database error: ${error.message}. Please make sure the database tables are set up correctly.`);
  }
}

async function render(table, listId, type) {
  console.log(`[v0] Rendering ${table} to ${listId}`);
  
  const pool = document.getElementById(listId);
  if (!pool) {
    console.error(`[v0] Pool element ${listId} not found`);
    return;
  }
  
  pool.innerHTML = '';
  
  try {
    const items = await loadFromDatabase(table);
    console.log(`[v0] Loaded ${items.length} items from ${table}`);
    
    items.forEach(item => {
      const tile = document.createElement('div');
      tile.className = 'tile ' + type;
      tile.id = item.id;
      tile.draggable = true;
      tile.ondragstart = drag;
      tile.onclick = toggleSelection;
      
      const span = document.createElement('span');
      span.textContent = item.name;
      tile.appendChild(span);
      
      // Add delete button exactly like working version
      const del = document.createElement('button');
      del.textContent = '❌';
      del.onclick = (e) => { 
        e.stopPropagation(); 
        deleteResource(table, item.id, listId, type); 
      };
      
      const btnWrap = document.createElement('div');
      btnWrap.className = 'tile-buttons';
      btnWrap.appendChild(del);
      tile.appendChild(btnWrap);
      
      pool.appendChild(tile);
      console.log(`[v0] Created tile: ${item.name}`);
    });
    
    console.log(`[v0] Finished rendering ${items.length} tiles to ${listId}`);
  } catch (error) {
    console.error(`[v0] Error in render:`, error);
  }
}

function showPage(n) {
  document.getElementById('page1').style.display = 'none';
  document.getElementById('page2').style.display = 'none';
  
  document.getElementById('tab1').classList.remove('active');
  document.getElementById('tab2').classList.remove('active');
  
  document.getElementById('page' + n).style.display = 'block';
  document.getElementById('tab' + n).classList.add('active');
  
  if (n === 2) populateSaved();
  if (n === 1) loadLocationData();
}

function allowDrop(ev) {
  ev.preventDefault();
}

function drag(ev) {
  ev.dataTransfer.setData('text', ev.target.id);
  
  if (ev.target.classList.contains('tile')) {
    ev.dataTransfer.setData('type', 'tile');
  } else if (ev.target.classList.contains('column')) {
    ev.dataTransfer.setData('type', 'column');
    ev.dataTransfer.setData('columnId', ev.target.id);
  }
}

function findClosestColumn(x) {
  const columns = Array.from(document.querySelectorAll('#board .column'));
  
  columns.sort((a, b) => {
    const rectA = a.getBoundingClientRect();
    const rectB = b.getBoundingClientRect();
    const distA = Math.abs(rectA.left - x);
    const distB = Math.abs(rectB.left - x);
    return distA - distB;
  });
  
  if (columns.length > 0) {
    const closest = columns[0];
    const rect = closest.getBoundingClientRect();
    
    if (x > rect.left + rect.width / 2) {
      return closest.nextElementSibling;
    } else {
      return closest;
    }
  }
  
  return null;
}

function drop(ev) {
  ev.preventDefault();
  const id = ev.dataTransfer.getData('text');
  const type = ev.dataTransfer.getData('type');
  const columnId = ev.dataTransfer.getData('columnId');
  
  if (type === 'column') {
    const column = document.getElementById(columnId);
    const board = document.getElementById('board');
    const closestColumn = findClosestColumn(ev.clientX);
    
    if (closestColumn && closestColumn !== column) {
      board.insertBefore(column, closestColumn);
    } else if (!closestColumn) {
      board.appendChild(column);
    }
    
    saveCurrentBoard();
    return;
  }
  
  const orig = document.getElementById(id);
  if (!orig || !orig.classList.contains('tile')) return;
  
  const col = ev.target.closest('.column') || 
             ev.target.closest('.resource-list') || 
             ev.target.closest('.permanent-box') ||
             ev.target.closest('.location-zone');
  
  if (col) {
    if (col.classList.contains('column')) {
      col.appendChild(orig);
      addTileButtons(orig);
      saveCurrentBoard();
    } else if (col.classList.contains('resource-list')) {
      const existingBtns = orig.querySelector('.tile-buttons');
      if (existingBtns) existingBtns.remove();
      col.appendChild(orig);
      saveCurrentBoard();
    } else if (col.classList.contains('permanent-box')) {
      col.appendChild(orig);
      addTileButtons(orig);
      saveCurrentBoard();
    } else if (col.classList.contains('location-zone')) {
      const locationName = col.querySelector('h3').textContent.replace(/[🏙️🏁🌉 ]/g, '').trim();
      
      const syntheticEvent = {
        preventDefault: () => {},
        dataTransfer: {
          getData: (type) => type === 'text' ? orig.id : 'tile'
        },
        target: col,
        clientX: ev.clientX,
        clientY: ev.clientY
      };
      
      dropLocation(syntheticEvent, locationName);
      addTileButtons(orig);
    }
  }
}

function addTileButtons(tile) {
  const existingBtns = tile.querySelector('.tile-buttons');
  if (existingBtns) existingBtns.remove();
  
  const btns = document.createElement('div');
  btns.className = 'tile-buttons';
  
  const ret = document.createElement('button');
  ret.textContent = '↩️';
  ret.title = 'Return to resource list';
  ret.onclick = (e) => {
    e.stopPropagation();
    returnTileToResourceList(tile.id);
  };
  
  const del = document.createElement('button');
  del.textContent = '❌';
  del.title = 'Delete tile';
  del.onclick = (e) => {
    e.stopPropagation();
    delSiteTile(tile.id);
  };
  
  btns.appendChild(ret);
  btns.appendChild(del);
  tile.appendChild(btns);
}

function returnTileToResourceList(id) {
  const tile = document.getElementById(id);
  if (!tile) return;
  
  let listId;
  if (tile.classList.contains('crew')) listId = 'crewList';
  else if (tile.classList.contains('truck')) listId = 'truckList';
  else if (tile.classList.contains('trailer')) listId = 'trailerList';
  else if (tile.classList.contains('equipment')) listId = 'equipmentList';
  else return;
  
  const list = document.getElementById(listId);
  if (list) {
    list.appendChild(tile);
    
    const btns = tile.querySelector('.tile-buttons');
    if (btns) btns.remove();
    
    saveCurrentBoard();
    saveLocationData();
  }
}

async function saveCurrentBoard() {
  try {
    document.querySelectorAll('#board .column input').forEach(input => {
      input.setAttribute('value', input.value);
    });
    
    const saveContainer = document.createElement('div');
    
    const boardContent = document.createElement('div');
    boardContent.setAttribute('data-content-type', 'board');
    boardContent.innerHTML = document.getElementById('board').innerHTML;
    saveContainer.appendChild(boardContent);
    
    ['off-box', 'available-box', 'shop-box', 'djmuse-box'].forEach(boxId => {
      const boxContent = document.createElement('div');
      boxContent.setAttribute('data-content-type', boxId);
      boxContent.innerHTML = document.getElementById(boxId).innerHTML;
      saveContainer.appendChild(boxContent);
    });
    
    const scheduleData = {
      id: 'current_' + Date.now(),
      time_created: new Date().toISOString(),
      html_content: saveContainer.innerHTML,
      is_current: true
    };
    
    await saveToDatabase('schedules', scheduleData);
    console.log('[v0] Board saved to database');
  } catch (error) {
    console.error('[v0] Error saving board:', error);
  }
}

async function saveLocationData() {
  try {
    const locations = {
      KC: [],
      Indy: [],
      STL: []
    };
    
    document.querySelectorAll('.location-zone').forEach(zone => {
      const location = zone.querySelector('h3').textContent.replace(/[🏙️🏁🌉 ]/g, '').trim();
      zone.querySelectorAll('.tile').forEach(tile => {
        locations[location].push({
          id: tile.id,
          html: tile.outerHTML
        });
      });
    });
    
    const locationData = {
      id: 'locations_current',
      locations: JSON.stringify(locations),
      updated_at: new Date().toISOString()
    };
    
    await saveToDatabase('locations', locationData);
    console.log('[v0] Location data saved to database');
  } catch (error) {
    console.error('[v0] Error saving location data:', error);
  }
}

async function loadAllData() {
  try {
    await renderAll();
    await loadCurrentBoard();
    await loadLocationData();
    console.log('[v0] All data loaded from database');
  } catch (error) {
    console.error('[v0] Error loading data:', error);
  }
}

async function loadCurrentBoard() {
  try {
    const schedules = await loadFromDatabase('schedules');
    const currentSchedule = schedules.find(s => s.is_current) || schedules[0];
    
    if (currentSchedule) {
      const tmp = document.createElement('div');
      tmp.innerHTML = currentSchedule.html_content;
      
      const boardContent = tmp.querySelector('[data-content-type="board"]');
      if (boardContent) {
        document.getElementById('board').innerHTML = boardContent.innerHTML;
      }
      
      ['off-box', 'available-box', 'shop-box', 'djmuse-box'].forEach(boxId => {
        const boxContent = tmp.querySelector(`[data-content-type="${boxId}"]`);
        if (boxContent) {
          document.getElementById(boxId).innerHTML = boxContent.innerHTML;
        }
      });
      
      reattachEventHandlers();
    }
  } catch (error) {
    console.error('[v0] Error loading current board:', error);
  }
}

async function loadLocationData() {
  try {
    const locationRecords = await loadFromDatabase('locations');
    const currentLocation = locationRecords.find(l => l.id === 'locations_current');
    
    if (currentLocation) {
      const locations = JSON.parse(currentLocation.locations || '{}');
      
      document.querySelectorAll('.location-zone').forEach(zone => {
        const header = zone.querySelector('h3');
        zone.innerHTML = '';
        zone.appendChild(header);
      });
      
      Object.keys(locations).forEach(location => {
        let zoneId;
        if (location === 'KC') zoneId = 'kc-zone';
        else if (location === 'Indy') zoneId = 'indy-zone';
        else if (location === 'STL') zoneId = 'stl-zone';
        else return;
        
        const zone = document.getElementById(zoneId);
        if (!zone) return;
        
        locations[location].forEach(item => {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = item.html;
          const tile = tempDiv.firstChild;
          
          tile.draggable = true;
          tile.ondragstart = drag;
          
          const returnBtn = tile.querySelector('.tile-buttons button:first-child');
          if (returnBtn) returnBtn.onclick = (e) => {
            e.stopPropagation();
            returnTileToResourceList(item.id);
          };
          
          const delBtn = tile.querySelector('.tile-buttons button:last-child');
          if (delBtn) delBtn.onclick = (e) => {
            e.stopPropagation();
            delSiteTile(item.id);
          };
          
          zone.appendChild(tile);
        });
      });
    }
  } catch (error) {
    console.error('[v0] Error loading location data:', error);
  }
}

function reattachEventHandlers() {
  document.querySelectorAll('#board .column').forEach(col => {
    col.ondragover = allowDrop;
    col.ondrop = drop;
    col.draggable = true;
    col.ondragstart = dragColumn;
  });
  
  document.querySelectorAll('#board .tile, .permanent-box .tile').forEach(tile => {
    tile.draggable = true;
    tile.ondragstart = drag;
    
    const returnBtn = tile.querySelector('.tile-buttons button:first-child');
    if (returnBtn) returnBtn.onclick = (e) => {
      e.stopPropagation();
      returnTileToResourceList(tile.id);
    };
    
    const delBtn = tile.querySelector('.tile-buttons button:last-child');
    if (delBtn) delBtn.onclick = (e) => {
      e.stopPropagation();
      delSiteTile(tile.id);
    };
  });
}

async function syncData() {
  const syncBtn = document.getElementById('syncBtn');
  const originalText = syncBtn.textContent;
  
  try {
    syncBtn.textContent = '⏳ Syncing...';
    syncBtn.disabled = true;
    
    await saveCurrentBoard();
    await saveLocationData();
    await loadAllData();
    
    syncBtn.textContent = '✅ Synced!';
    setTimeout(() => {
      syncBtn.textContent = originalText;
      syncBtn.disabled = false;
    }, 2000);
  } catch (error) {
    console.error('[v0] Sync failed:', error);
    syncBtn.textContent = '❌ Failed!';
    setTimeout(() => {
      syncBtn.textContent = originalText;
      syncBtn.disabled = false;
    }, 2000);
  }
}

async function renderAll() {
  console.log(`[v0] Starting renderAll()`);
  await render('crews', 'crewList', 'crew');
  await render('trucks', 'truckList', 'truck');
  await render('trailers', 'trailerList', 'trailer');
  await render('equipment', 'equipmentList', 'equipment');
  console.log(`[v0] Finished renderAll()`);
}

function delSiteTile(id) {
  const tile = document.getElementById(id);
  if (tile) tile.remove();
  saveCurrentBoard();
  saveLocationData();
}

// Sites
let siteCount = 0;
function addSite() {
  const name = prompt('Site name:');
  if (!name) return;
  
  const col = document.createElement('div');
  col.className = 'column';
  col.id = 'site_' + siteCount++;
  col.ondragover = allowDrop;
  col.ondrop = drop;
  col.draggable = true;
  col.ondragstart = dragColumn;
  
  const inp = document.createElement('input');
  inp.value = name;
  inp.onclick = (e) => e.stopPropagation();
  col.appendChild(inp);
  
  document.getElementById('board').appendChild(col);
  saveCurrentBoard();
}

function deleteSite() {
  const selectedColumns = document.querySelectorAll('.column.selected');
  
  if (selectedColumns.length === 0) {
    alert('Please select a site to delete first');
    return;
  }
  
  selectedColumns.forEach(column => {
    column.remove();
  });
  
  saveCurrentBoard();
}

function clearSites() {
  document.querySelectorAll('.column').forEach(c => c.remove());
  renderAll();
  saveCurrentBoard();
}

async function eraseBoard() {
  if (confirm('This will erase all data. Are you sure?')) {
    try {
      const tables = ['crews', 'trucks', 'trailers', 'equipment', 'schedules', 'locations'];
      
      for (const table of tables) {
        const { error } = await supabaseClient
          .from(table)
          .delete()
          .neq('id', '');
        
        if (error) throw error;
      }
      
      document.querySelectorAll('.column').forEach(c => c.remove());
      await renderAll();
      clearLocationBoard();
      
      alert('All data has been erased.');
    } catch (error) {
      console.error('[v0] Error erasing board:', error);
      alert('Error erasing data. Please try again.');
    }
  }
}

// Snapshot functions
function saveSnapshot() {
  saveCurrentBoard();
  try {
    html2canvas(document.getElementById('board')).then(canvas => {
      const a = document.createElement('a');
      a.download = 'snapshot_' + new Date().toISOString() + '.png';
      a.href = canvas.toDataURL();
      a.click();
    });
  } catch (e) {
    console.error("Error creating snapshot:", e);
    alert("Error creating snapshot. Please make sure html2canvas is loaded correctly.");
  }
}

// Page 2 functions
async function populateSaved() {
  const sel = document.getElementById('savedSelect');
  sel.innerHTML = '';
  
  const schedules = await loadFromDatabase('schedules');
  schedules.forEach((s, i) => {
    sel.append(new Option(new Date(s.time_created).toLocaleString(), i));
  });
}

async function loadSavedPage2() {
  const idx = document.getElementById('savedSelect').value;
  const schedules = await loadFromDatabase('schedules');
  const disp = document.getElementById('savedBoardDisplay');
  disp.innerHTML = '';
  
  if (schedules[idx]) {
    const tmp = document.createElement('div');
    tmp.innerHTML = schedules[idx].html_content;
    
    tmp.querySelectorAll('.column').forEach(c => {
      const clone = c.cloneNode(true);
      
      const origInput = c.querySelector('input');
      if (origInput) {
        const cloneInput = clone.querySelector('input');
        if (cloneInput) {
          cloneInput.setAttribute('value', origInput.value);
          cloneInput.value = origInput.value;
        }
      }
      
      disp.appendChild(clone);
    });
  }
}

function saveSnapshotPage2() {
  try {
    html2canvas(document.getElementById('savedBoardDisplay')).then(canvas => {
      const a = document.createElement('a');
      a.download = 'saved_snapshot_' + new Date().toISOString() + '.png';
      a.href = canvas.toDataURL();
      a.click();
    });
  } catch (e) {
    console.error("Error creating snapshot:", e);
    alert("Error creating snapshot. Please make sure html2canvas is loaded correctly.");
  }
}

async function clearSavedLogs() {
  if (confirm('Clear all saved schedules?')) {
    try {
      const { error } = await supabaseClient
        .from('schedules')
        .delete()
        .neq('id', '');
      
      if (error) throw error;
      
      document.getElementById('savedBoardDisplay').innerHTML = '';
      populateSaved();
    } catch (error) {
      console.error('[v0] Error clearing saved logs:', error);
    }
  }
}

function clearLocationBoard() {
  document.querySelectorAll('.location-zone').forEach(zone => {
    const header = zone.querySelector('h3');
    zone.innerHTML = '';
    zone.appendChild(header);
  });
  
  saveLocationData();
}

function saveLocationBoard() {
  saveLocationData();
  alert('Locations saved!');
}

// Touch support for mobile devices
function initTouchSupport() {
  let touchDragSource = null;
  
  document.addEventListener('touchstart', function(e) {
    if (e.target.classList.contains('tile')) {
      touchDragSource = e.target;
      e.target.classList.add('dragging');
    }
  }, { passive: false });
  
  document.addEventListener('touchend', function(e) {
    if (touchDragSource) {
      touchDragSource.classList.remove('dragging');
      
      const touch = e.changedTouches[0];
      const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
      
      if (dropTarget) {
        const col = dropTarget.closest('.column') || 
                   dropTarget.closest('.resource-list') || 
                   dropTarget.closest('.permanent-box') ||
                   dropTarget.closest('.location-zone');
        
        if (col) {
          if (col.classList.contains('location-zone')) {
            const locationName = col.querySelector('h3').textContent.replace(/[🏙️🏁🌉 ]/g, '').trim();
            
            const syntheticEvent = {
              preventDefault: () => {},
              dataTransfer: {
                getData: (type) => type === 'text' ? touchDragSource.id : 'tile'
              },
              target: dropTarget,
              clientX: touch.clientX,
              clientY: touch.clientY
            };
            
            dropLocation(syntheticEvent, locationName);
          } else {
            const syntheticEvent = {
              preventDefault: () => {},
              dataTransfer: {
                getData: (type) => {
                  if (type === 'text') return touchDragSource.id;
                  if (type === 'type') return 'tile';
                  return '';
                },
                setData: () => {}
              },
              target: dropTarget,
              clientX: touch.clientX,
              clientY: touch.clientY
            };
            
            drop(syntheticEvent);
          }
        }
      }
      
      touchDragSource = null;
    }
  }, { passive: false });
  
  document.addEventListener('touchmove', function(e) {
    if (touchDragSource) {
      e.preventDefault();
      
      const touch = e.touches[0];
      const dropIndicator = document.getElementById('touch-drop-indicator') || 
                           createDropIndicator();
      
      dropIndicator.style.left = (touch.clientX - 20) + 'px';
      dropIndicator.style.top = (touch.clientY - 20) + 'px';
      dropIndicator.style.display = 'block';
    }
  }, { passive: false });
  
  function createDropIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'touch-drop-indicator';
    indicator.style.position = 'fixed';
    indicator.style.width = '40px';
    indicator.style.height = '40px';
    indicator.style.borderRadius = '50%';
    indicator.style.backgroundColor = 'rgba(209, 163, 255, 0.5)';
    indicator.style.pointerEvents = 'none';
    indicator.style.zIndex = '9999';
    document.body.appendChild(indicator);
    return indicator;
  }
}

// Initialize on page load
window.addEventListener('DOMContentLoaded', function() {
  initializeExistingSiteColumns();
  loadCurrentBoard();
  loadLocationData();
  render('crews', 'crewList', 'crew');
  render('trucks', 'truckList', 'truck');
  render('trailers', 'trailerList', 'trailer');
  render('equipment', 'equipmentList', 'equipment');
});

function addCrew() {
  console.log('[v0] addCrew called');
  addResource('crews', 'crewInput', 'crewList', 'crew');
}

function addTruck() {
  console.log('[v0] addTruck called');
  addResource('trucks', 'truckInput', 'truckList', 'truck');
}

function addTrailer() {
  console.log('[v0] addTrailer called');
  addResource('trailers', 'trailerInput', 'trailerList', 'trailer');
}

function addEquipment() {
  console.log('[v0] addEquipment called');
  addResource('equipment', 'equipmentInput', 'equipmentList', 'equipment');
}

function toggleSelection(event) {
  const tile = event.target.closest('.tile');
  if (tile) {
    tile.classList.toggle('selected');
  }
}

async function deleteResource(table, id, listId, type) {
  try {
    console.log(`[v0] Deleting resource ${id} from ${table}`);
    
    const { error } = await supabaseClient
      .from(table)
      .delete()
      .eq('id', id);
    
    if (error) {
      console.error(`[v0] Error deleting from ${table}:`, error);
      alert(`Error deleting resource: ${error.message}`);
    } else {
      console.log(`[v0] Successfully deleted ${id} from ${table}`);
      await render(table, listId, type);
    }
  } catch (error) {
    console.error(`[v0] Error in deleteResource:`, error);
    alert(`Error deleting resource: ${error.message}`);
  }
}

function dragColumn(ev) {
  ev.dataTransfer.setData('text', ev.target.id);
  ev.dataTransfer.setData('type', 'column');
  ev.dataTransfer.setData('columnId', ev.target.id);
}

function dropLocation(ev, locationName) {
  ev.preventDefault();
  const id = ev.dataTransfer.getData('text');
  const type = ev.dataTransfer.getData('type');
  
  if (type === 'tile') {
    const tile = document.getElementById(id);
    if (!tile) return;
    
    const zone = document.getElementById(locationName + '-zone');
    if (zone) {
      zone.appendChild(tile);
      saveLocationData();
    }
  }
}

function initializeExistingSiteColumns() {
  const existingColumns = document.querySelectorAll('#board .column');
  existingColumns.forEach(column => {
    if (!column.draggable) {
      column.draggable = true;
      column.ondragstart = dragColumn;
    }
  });
}

// Clear functions for resource sections
function clearCrew() {
  document.getElementById('crewInput').value = '';
  render('crews', 'crewList', 'crew');
}

function clearTruck() {
  document.getElementById('truckInput').value = '';
  render('trucks', 'truckList', 'truck');
}

function clearTrailer() {
  document.getElementById('trailerInput').value = '';
  render('trailers', 'trailerList', 'trailer');
}

function clearEquipment() {
  document.getElementById('equipmentInput').value = '';
  render('equipment', 'equipmentList', 'equipment');
}
</script>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
function exportToPDF() {
  const loadingDiv = document.createElement('div');
  loadingDiv.innerHTML = 'Generating PDF...';
  loadingDiv.style.position = 'fixed';
  loadingDiv.style.top = '50%';
  loadingDiv.style.left = '50%';
  loadingDiv.style.transform = 'translate(-50%, -50%)';
  loadingDiv.style.background = 'rgba(0,0,0,0.7)';
  loadingDiv.style.color = 'white';
  loadingDiv.style.padding = '20px';
  loadingDiv.style.borderRadius = '10px';
  loadingDiv.style.zIndex = '9999';
  document.body.appendChild(loadingDiv);

  html2canvas(document.getElementById('board')).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    pdf.setFontSize(18);
    pdf.text('R&S Weekly Schedule', pdfWidth/2, 15, {align: 'center'});
    pdf.setFontSize(12);
    pdf.text('Generated: ' + new Date().toLocaleString(), pdfWidth/2, 22, {align: 'center'});
    const imgProps = pdf.getImageProperties(imgData);
    const imgWidth = pdfWidth - 20;
    const imgHeight = imgWidth * imgProps.height / imgProps.width;
    pdf.addImage(imgData, 'PNG', 10, 30, imgWidth, imgHeight);
    pdf.save('schedule_' + new Date().toISOString() + '.pdf');
    document.body.removeChild(loadingDiv);
  });
}
</script>

</body>
</html>

